<mxfile host="Claude" modified="2026-02-13T00:00:00.000Z" agent="Claude Code" version="1.0">
  <diagram id="resolve_company_id" name="_resolve_company_id">
    <mxGraphModel dx="1422" dy="762" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="850">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Start -->
        <mxCell id="rcid_start" value="_resolve_company_id(conn, email, now, *, customer_id, user_id)" style="rounded=1;whiteSpace=wrap;html=1;arcSize=50;fillColor=#4A9EFF;fontColor=#FFFFFF;strokeColor=#2D7CD6;" vertex="1" parent="1">
          <mxGeometry x="175" y="20" width="450" height="40" as="geometry"/>
        </mxCell>

        <!-- Extract domain -->
        <mxCell id="rcid_extract" value="Extract domain from email" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="275" y="100" width="250" height="40" as="geometry"/>
        </mxCell>

        <!-- Check domain valid and not public -->
        <mxCell id="rcid_check_domain" value="Domain exists &amp;amp;&amp;amp;&#xa;not public?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;" vertex="1" parent="1">
          <mxGeometry x="320" y="180" width="160" height="80" as="geometry"/>
        </mxCell>

        <!-- Return None (public/no domain) -->
        <mxCell id="rcid_return_none" value="Return None" style="rounded=1;whiteSpace=wrap;html=1;arcSize=50;fillColor=#4A9EFF;fontColor=#FFFFFF;strokeColor=#2D7CD6;" vertex="1" parent="1">
          <mxGeometry x="575" y="195" width="150" height="40" as="geometry"/>
        </mxCell>

        <!-- Lookup existing company by domain -->
        <mxCell id="rcid_lookup" value="resolve_company_by_domain(conn, domain)" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="250" y="310" width="300" height="40" as="geometry"/>
        </mxCell>

        <!-- Company found? -->
        <mxCell id="rcid_found" value="Company&#xa;found?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;" vertex="1" parent="1">
          <mxGeometry x="320" y="390" width="160" height="80" as="geometry"/>
        </mxCell>

        <!-- Return existing company id -->
        <mxCell id="rcid_return_existing" value="Return company[&quot;id&quot;]" style="rounded=1;whiteSpace=wrap;html=1;arcSize=50;fillColor=#D5E8D4;fontColor=#000000;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="575" y="410" width="175" height="40" as="geometry"/>
        </mxCell>

        <!-- Auto-create company -->
        <mxCell id="rcid_create" value="INSERT new company&#xa;(name = domain, domain = domain)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="250" y="520" width="300" height="50" as="geometry"/>
        </mxCell>

        <!-- user_id provided? -->
        <mxCell id="rcid_check_user" value="user_id&#xa;provided?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#FFF2CC;strokeColor=#D6B656;" vertex="1" parent="1">
          <mxGeometry x="320" y="620" width="160" height="80" as="geometry"/>
        </mxCell>

        <!-- Create user_companies linkage -->
        <mxCell id="rcid_link_user" value="INSERT user_companies visibility row" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="100" y="635" width="170" height="50" as="geometry"/>
        </mxCell>

        <!-- Ensure domain identifier -->
        <mxCell id="rcid_ensure_id" value="ensure_domain_identifier(conn, company_id, domain)" style="shape=process;whiteSpace=wrap;html=1;backgroundOutline=1;fillColor=#DAE8FC;strokeColor=#6C8EBF;" vertex="1" parent="1">
          <mxGeometry x="225" y="750" width="350" height="40" as="geometry"/>
        </mxCell>

        <!-- Return new company id -->
        <mxCell id="rcid_return_new" value="Return company_id" style="rounded=1;whiteSpace=wrap;html=1;arcSize=50;fillColor=#D5E8D4;fontColor=#000000;strokeColor=#82B366;" vertex="1" parent="1">
          <mxGeometry x="300" y="830" width="200" height="40" as="geometry"/>
        </mxCell>

        <!-- Edges -->
        <mxCell id="e_start_extract" value="" style="endArrow=classic;" edge="1" source="rcid_start" target="rcid_extract" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_extract_check" value="" style="endArrow=classic;" edge="1" source="rcid_extract" target="rcid_check_domain" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_check_none" value="No" style="endArrow=classic;" edge="1" source="rcid_check_domain" target="rcid_return_none" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_check_lookup" value="Yes" style="endArrow=classic;" edge="1" source="rcid_check_domain" target="rcid_lookup" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_lookup_found" value="" style="endArrow=classic;" edge="1" source="rcid_lookup" target="rcid_found" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_found_existing" value="Yes" style="endArrow=classic;" edge="1" source="rcid_found" target="rcid_return_existing" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_found_create" value="No" style="endArrow=classic;" edge="1" source="rcid_found" target="rcid_create" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_create_checkuser" value="" style="endArrow=classic;" edge="1" source="rcid_create" target="rcid_check_user" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_checkuser_link" value="Yes" style="endArrow=classic;" edge="1" source="rcid_check_user" target="rcid_link_user" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_checkuser_ensure" value="No" style="endArrow=classic;" edge="1" source="rcid_check_user" target="rcid_ensure_id" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_link_ensure" value="" style="endArrow=classic;" edge="1" source="rcid_link_user" target="rcid_ensure_id" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e_ensure_return" value="" style="endArrow=classic;" edge="1" source="rcid_ensure_id" target="rcid_return_new" parent="1">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
