{# Shared grid macros for dynamic column rendering across entity list pages. #}

{#
  grid_headers — render <th> cells for view columns.

  Args:
    view:       dict with "columns" list (each has field_key)
    entity_def: registry EntityDef (has .fields dict)
    sort:       current sort string (e.g. "name", "-score")
    search_url: HTMX search endpoint (e.g. "/contacts/search")
    params:     dict of query params to preserve (q, scope, etc.)
#}
{% macro grid_headers(view, entity_def, sort, search_url, params) %}
  {% set s = sort|default('', true) %}
  {% for col in view.columns %}
    {% set fk = col.field_key %}
    {% set fdef = entity_def.fields[fk] if fk in entity_def.fields else none %}
    {% if fdef and fdef.type != 'hidden' %}
      {% set col_label = col.label_override or fdef.label %}
      {% set w_style = 'style="width:' ~ col.width_px ~ 'px;"' if col.width_px else '' %}
      {% if fdef.sortable %}
        {% if s == fk %}
          {% set next_sort = '-' ~ fk %}
          {% set arrow = '&#9650;' %}
        {% elif s == '-' ~ fk %}
          {% set next_sort = fk %}
          {% set arrow = '&#9660;' %}
        {% else %}
          {% set next_sort = fk %}
          {% set arrow = '' %}
        {% endif %}
        {% set qs_parts = [] %}
        {% for pk, pv in params.items() %}
          {% if pv %}{% if qs_parts.append(pk ~ '=' ~ (pv|urlencode)) %}{% endif %}{% endif %}
        {% endfor %}
        {% if qs_parts %}
          {% set qs = qs_parts|join('&') ~ '&sort=' ~ next_sort %}
        {% else %}
          {% set qs = 'sort=' ~ next_sort %}
        {% endif %}
        <th {{ w_style }}><a hx-get="{{ search_url }}?{{ qs }}" hx-target="#results"
               style="text-decoration:none;color:inherit;cursor:pointer;">{{ col_label }} {{ arrow }}</a></th>
      {% else %}
        <th {{ w_style }}>{{ col_label }}</th>
      {% endif %}
    {% endif %}
  {% endfor %}
{% endmacro %}


{#
  grid_cells — render <td> cells for a single data row.

  Args:
    row:        dict of field values (from execute_view)
    view:       dict with "columns" list
    entity_def: registry EntityDef
    entity_type: string entity type key (e.g. "contact", "company")
#}
{% macro grid_cells(row, view, entity_def, entity_type='') %}
  {% for col in view.columns %}
    {% set fk = col.field_key %}
    {% set fdef = entity_def.fields[fk] if fk in entity_def.fields else none %}
    {% if fdef and fdef.type != 'hidden' %}
      {% set val = row[fk] if fk in row else none %}
      <td{% if fdef.editable and entity_type %} data-editable data-entity-type="{{ entity_type }}" data-entity-id="{{ row.id }}" data-field-key="{{ fdef.db_column }}" data-edit-type="{{ 'select' if fdef.select_options else 'text' }}"{% if fdef.select_options %} data-options="{{ fdef.select_options|join(',') }}"{% endif %}{% endif %}>
        {% if val is none or val == '' %}
          <small style="color:var(--pico-muted-color);">&mdash;</small>
        {% elif fdef.type == 'number' and fk == 'score' %}
          {# Score field: progress bar #}
          {% if val is not none %}
          <div style="display:flex;align-items:center;gap:6px;">
            <div style="background:#e0e0e0;border-radius:3px;height:6px;width:60px;">
              <div style="background:var(--pico-primary-color, #1095c1);height:100%;border-radius:3px;width:{{ (val * 100)|int }}%;"></div>
            </div>
            <small>{{ '%.0f'|format(val * 100) }}%</small>
          </div>
          {% endif %}
        {% elif fdef.type == 'number' %}
          {{ val }}
        {% elif fdef.type == 'datetime' %}
          {{ val|datetime }}
        {% elif fdef.link %}
          {% set href = fdef.link|resolve_link(row) %}
          {% if href %}
            <a href="{{ href }}">{{ val }}</a>
          {% else %}
            {{ val }}
          {% endif %}
        {% else %}
          {{ val }}
        {% endif %}
      </td>
    {% endif %}
  {% endfor %}
{% endmacro %}


{#
  grid_pagination — render prev/next navigation.

  Args:
    page:        current page number
    total_pages: total number of pages
    page_url:    base URL for page links (e.g. "/contacts")
    params:      dict of query params to preserve
#}
{% macro grid_pagination(page, total_pages, page_url, params) %}
  {% if total_pages > 1 %}
  <nav>
    <ul>
      {% if page > 1 %}
        {% set qs_parts = [] %}
        {% for pk, pv in params.items() %}
          {% if pv %}{% if qs_parts.append(pk ~ '=' ~ (pv|urlencode)) %}{% endif %}{% endif %}
        {% endfor %}
        {% if qs_parts %}
          {% set qs = qs_parts|join('&') ~ '&page=' ~ (page - 1) %}
        {% else %}
          {% set qs = 'page=' ~ (page - 1) %}
        {% endif %}
        <li><a href="{{ page_url }}?{{ qs }}">Previous</a></li>
      {% endif %}
      <li>Page {{ page }} of {{ total_pages }}</li>
      {% if page < total_pages %}
        {% set qs_parts = [] %}
        {% for pk, pv in params.items() %}
          {% if pv %}{% if qs_parts.append(pk ~ '=' ~ (pv|urlencode)) %}{% endif %}{% endif %}
        {% endfor %}
        {% if qs_parts %}
          {% set qs = qs_parts|join('&') ~ '&page=' ~ (page + 1) %}
        {% else %}
          {% set qs = 'page=' ~ (page + 1) %}
        {% endif %}
        <li><a href="{{ page_url }}?{{ qs }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
{% endmacro %}
