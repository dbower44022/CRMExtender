{% set q_enc = q|default('', true)|urlencode %}
{% set s = sort|default('name', true) %}
{% set sc = scope|default('all', true) %}
{% if contacts %}
<table>
  <thead>
    <tr>
      <th><a hx-get="/contacts/search?q={{ q_enc }}&sort={% if s == 'name' %}-name{% else %}name{% endif %}&scope={{ sc }}"
             hx-target="#results" href="/contacts?q={{ q_enc }}&sort={% if s == 'name' %}-name{% else %}name{% endif %}&scope={{ sc }}"
             style="text-decoration:none;color:inherit;cursor:pointer;">Name{% if s == 'name' %} &#9650;{% elif s == '-name' %} &#9660;{% endif %}</a></th>
      <th><a hx-get="/contacts/search?q={{ q_enc }}&sort={% if s == 'email' %}-email{% else %}email{% endif %}&scope={{ sc }}"
             hx-target="#results" href="/contacts?q={{ q_enc }}&sort={% if s == 'email' %}-email{% else %}email{% endif %}&scope={{ sc }}"
             style="text-decoration:none;color:inherit;cursor:pointer;">Email{% if s == 'email' %} &#9650;{% elif s == '-email' %} &#9660;{% endif %}</a></th>
      <th><a hx-get="/contacts/search?q={{ q_enc }}&sort={% if s == 'company' %}-company{% else %}company{% endif %}&scope={{ sc }}"
             hx-target="#results" href="/contacts?q={{ q_enc }}&sort={% if s == 'company' %}-company{% else %}company{% endif %}&scope={{ sc }}"
             style="text-decoration:none;color:inherit;cursor:pointer;">Company{% if s == 'company' %} &#9650;{% elif s == '-company' %} &#9660;{% endif %}</a></th>
      <th><a hx-get="/contacts/search?q={{ q_enc }}&sort={% if s == '-score' %}score{% else %}-score{% endif %}&scope={{ sc }}"
             hx-target="#results" href="/contacts?q={{ q_enc }}&sort={% if s == '-score' %}score{% else %}-score{% endif %}&scope={{ sc }}"
             style="text-decoration:none;color:inherit;cursor:pointer;">Score{% if s == '-score' %} &#9660;{% elif s == 'score' %} &#9650;{% endif %}</a></th>
      <th>Source</th>
    </tr>
  </thead>
  <tbody>
    {% for c in contacts %}
    <tr>
      <td><a href="/contacts/{{ c.id }}">{{ c.name or '(unnamed)' }}</a></td>
      <td>{{ c.email or '' }}</td>
      <td>
        {% if c.company_id %}
        <a href="/companies/{{ c.company_id }}">{{ c.company_name or '' }}</a>
        {% endif %}
      </td>
      <td>
        {% if c.score is not none %}
        <div style="display:flex;align-items:center;gap:6px;">
          <div style="background:#e0e0e0;border-radius:3px;height:6px;width:60px;">
            <div style="background:var(--pico-primary-color, #1095c1);height:100%;border-radius:3px;width:{{ (c.score * 100)|int }}%;"></div>
          </div>
          <small>{{ '%.0f'|format(c.score * 100) }}%</small>
        </div>
        {% else %}
        <small style="color:var(--pico-muted-color);">&mdash;</small>
        {% endif %}
      </td>
      <td>{{ c.source or '' }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% if total_pages > 1 %}
<nav>
  <ul>
    {% if page > 1 %}
    <li><a href="/contacts?q={{ q_enc }}&sort={{ s }}&scope={{ sc }}&page={{ page - 1 }}">Previous</a></li>
    {% endif %}
    <li>Page {{ page }} of {{ total_pages }}</li>
    {% if page < total_pages %}
    <li><a href="/contacts?q={{ q_enc }}&sort={{ s }}&scope={{ sc }}&page={{ page + 1 }}">Next</a></li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% else %}
<p class="empty-state">No contacts found.</p>
{% endif %}
