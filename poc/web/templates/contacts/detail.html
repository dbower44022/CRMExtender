{% extends "base.html" %}
{% block title %}{{ contact.name or 'Contact' }} â€” CRM Extender{% endblock %}

{% block content %}
<h1>{{ contact.name or '(unnamed)' }}</h1>

<div class="grid">
  <div>
    <!-- Conversations -->
    <h2>Conversations ({{ conversations|length }})</h2>
    {% if conversations %}
    <table>
      <thead>
        <tr>
          <th>Subject</th>
          <th>Status</th>
          <th>Last Activity</th>
        </tr>
      </thead>
      <tbody>
        {% for conv in conversations %}
        <tr>
          <td><a href="/conversations/{{ conv.id }}">{{ conv.title or '(no subject)' }}</a></td>
          <td>{{ conv.ai_status or conv.status or 'active' }}</td>
          <td>{{ conv.last_activity_at|datetime }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="empty-state">No conversations.</p>
    {% endif %}

    {% include "contacts/_affiliations.html" %}

    {% include "contacts/_phones.html" %}

    {% include "contacts/_emails.html" %}

    {% include "contacts/_addresses.html" %}

    {% include "notes/_notes.html" %}
  </div>

  <div>
    <!-- Sidebar -->
    <article>
      <header>
        Contact Info
        <a href="/contacts/{{ contact.id }}/edit" role="button" class="outline"
           style="float:right;padding:4px 12px;font-size:.85em;">Edit</a>
      </header>
      <dl class="detail-sidebar">
        {% for ident in email_identifiers %}
        <dt>Email</dt>
        <dd>{{ ident.value }}{% if ident.is_primary %} <small>(primary)</small>{% endif %}</dd>
        {% endfor %}

        <dt>Company</dt>
        <dd>
          {% if affiliations %}
          {% for aff in affiliations if aff.is_primary and aff.is_current %}
          <a href="/companies/{{ aff.company_id }}">{{ aff.company_name }}</a>
          {% if aff.role_name %}<small>({{ aff.role_name }})</small>{% endif %}
          {% endfor %}
          {% if not affiliations|selectattr('is_primary')|selectattr('is_current')|list %}
          {% for aff in affiliations if aff.is_current %}
          {% if loop.first %}<a href="/companies/{{ aff.company_id }}">{{ aff.company_name }}</a>{% endif %}
          {% endfor %}
          {% endif %}
          {% if affiliations|length > 1 %}
          <br><small>+{{ affiliations|length - 1 }} more</small>
          {% endif %}
          {% else %}
          <em>None</em>
          {% endif %}
        </dd>

        <dt>Source</dt>
        <dd>{{ contact.source or 'N/A' }}</dd>

        <dt>Status</dt>
        <dd>{{ contact.status or 'active' }}</dd>
      </dl>

      {% if social_profiles %}
      <h6>Social Profiles</h6>
      <ul>
        {% for sp in social_profiles %}
        <li>
          <strong>{{ sp.platform|title }}</strong>:
          <a href="{{ sp.profile_url }}" target="_blank" rel="noopener">{{ sp.username or sp.profile_url }}</a>
          {% if sp.headline %}<br><small>{{ sp.headline }}</small>{% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endif %}
      {% include "contacts/_score.html" %}
    </article>

    {% if relationships %}
    <article>
      <header>Relationships</header>
      <ul>
        {% for rel in relationships %}
        <li>
          <em>{{ rel.label }}</em>
          {% if rel.other_entity_type == 'company' %}
          <a href="/companies/{{ rel.other_id }}">{{ rel.other_name or rel.other_email or rel.other_id[:8] }}</a>
          {% else %}
          <a href="/contacts/{{ rel.other_id }}">{{ rel.other_name or rel.other_email or rel.other_id[:8] }}</a>
          {% endif %}
          {% if rel.props.strength is defined and rel.props.strength > 0 %}
          <span class="strength-bar-bg">
            <span class="strength-bar" style="width: {{ (rel.props.strength * 100)|int }}px"></span>
          </span>
          <small>{{ '%.0f'|format(rel.props.strength * 100) }}%</small>
          {% endif %}
          {% if rel.source == 'manual' %}
          <small class="badge">manual</small>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </article>
    {% endif %}
  </div>
</div>
{% endblock %}
