{% extends "base.html" %}
{% block title %}Dashboard â€” CRM Extender{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div style="margin-bottom: 1rem;">
  <button hx-post="/sync"
          hx-target="#sync-result"
          hx-swap="innerHTML"
          hx-indicator="#sync-spinner"
          class="outline">Sync Now</button>
  <span id="sync-spinner" class="htmx-indicator" style="font-size:.85em;">syncing...</span>
  <span id="sync-result" style="margin-left: 0.5rem;"></span>
</div>

<div class="grid">
  <article>
    <header>Conversations</header>
    <p><strong>{{ counts.conversations_total }}</strong> total</p>
    <p>{{ counts.conversations_open }} open &middot; {{ counts.conversations_closed }} closed</p>
  </article>
  <article>
    <header>Contacts</header>
    <p><strong>{{ counts.contacts }}</strong></p>
  </article>
  <article>
    <header>Companies</header>
    <p><strong>{{ counts.companies }}</strong></p>
  </article>
  <article>
    <header>Projects / Topics</header>
    <p><strong>{{ counts.projects }}</strong> projects &middot; <strong>{{ counts.topics }}</strong> topics</p>
  </article>
  <article>
    <header>Events</header>
    <p><strong>{{ counts.events }}</strong></p>
  </article>
</div>

{% if top_companies or top_contacts %}
<div class="grid">
  {% if top_companies %}
  <article>
    <header>Top Companies <small>({{ counts.scored_companies }} scored)</small></header>
    <table>
      <thead>
        <tr><th>Name</th><th>Score</th></tr>
      </thead>
      <tbody>
        {% for c in top_companies %}
        <tr>
          <td><a href="/companies/{{ c.id }}">{{ c.name }}</a></td>
          <td>
            <div style="display:flex;align-items:center;gap:6px;">
              <div style="background:#e0e0e0;border-radius:3px;height:6px;width:60px;">
                <div style="background:var(--pico-primary-color, #1095c1);height:100%;border-radius:3px;width:{{ (c.score * 100)|int }}%;"></div>
              </div>
              <small>{{ '%.0f'|format(c.score * 100) }}%</small>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <footer><a href="/companies?sort=-score">View all &rarr;</a></footer>
  </article>
  {% endif %}
  {% if top_contacts %}
  <article>
    <header>Top Contacts <small>({{ counts.scored_contacts }} scored)</small></header>
    <table>
      <thead>
        <tr><th>Name</th><th>Score</th></tr>
      </thead>
      <tbody>
        {% for c in top_contacts %}
        <tr>
          <td><a href="/contacts/{{ c.id }}">{{ c.name or c.email or '(unnamed)' }}</a></td>
          <td>
            <div style="display:flex;align-items:center;gap:6px;">
              <div style="background:#e0e0e0;border-radius:3px;height:6px;width:60px;">
                <div style="background:var(--pico-primary-color, #1095c1);height:100%;border-radius:3px;width:{{ (c.score * 100)|int }}%;"></div>
              </div>
              <small>{{ '%.0f'|format(c.score * 100) }}%</small>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <footer><a href="/contacts?sort=-score">View all &rarr;</a></footer>
  </article>
  {% endif %}
</div>
{% endif %}

{% if recent_conversations %}
<h2>Recent Conversations</h2>
<table>
  <thead>
    <tr>
      <th>Subject</th>
      <th>Status</th>
      <th>Messages</th>
      <th>Last Activity</th>
    </tr>
  </thead>
  <tbody>
    {% for conv in recent_conversations %}
    <tr>
      <td><a href="/conversations/{{ conv.id }}">{{ conv.title or '(no subject)' }}</a></td>
      <td>{{ conv.ai_status or conv.status or 'active' }}</td>
      <td>{{ conv.communication_count }}</td>
      <td>{{ conv.last_activity_at|datetime }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}
{% endblock %}
