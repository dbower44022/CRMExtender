{% extends "base.html" %}
{% block title %}Edit View: {{ view.name }} — CRM Extender{% endblock %}
{% block content %}
<h2>Edit View</h2>
<p><a href="/views/{{ view.id }}">&larr; Back to {{ view.name }}</a></p>

{% if saved %}
<article style="background:var(--pico-ins-color);padding:0.5rem 1rem;margin-bottom:1rem;">
  View saved successfully.
</article>
{% endif %}

<form method="post" action="/views/{{ view.id }}/edit" id="edit-view-form">
  {# View name #}
  <label for="name">View Name</label>
  <input type="text" id="name" name="name" value="{{ view.name }}" required>

  {# Sort #}
  <fieldset>
    <legend>Sort</legend>
    <div style="display:flex;gap:1rem;align-items:end;">
      <div style="flex:1;">
        <label for="sort_field">Sort By</label>
        <select id="sort_field" name="sort_field">
          {% for fk, fdef in entity_def.fields.items() %}
          {% if fdef.sortable %}
          <option value="{{ fk }}" {% if view.sort_field == fk %}selected{% endif %}>{{ fdef.label }}</option>
          {% endif %}
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="sort_direction">Direction</label>
        <select id="sort_direction" name="sort_direction">
          <option value="asc" {% if view.sort_direction == 'asc' %}selected{% endif %}>Ascending</option>
          <option value="desc" {% if view.sort_direction == 'desc' %}selected{% endif %}>Descending</option>
        </select>
      </div>
    </div>
  </fieldset>

  {# Per-page #}
  <label for="per_page">Results Per Page</label>
  <select id="per_page" name="per_page">
    {% for n in [25, 50, 100, 200] %}
    <option value="{{ n }}" {% if view.per_page == n %}selected{% endif %}>{{ n }}</option>
    {% endfor %}
  </select>

  {# Columns — ordered list with add/remove/reorder #}
  <fieldset>
    <legend>Columns</legend>
    <label style="font-size:0.85rem;color:var(--pico-muted-color);">Drag or use arrows to reorder. Remove columns with &times;.</label>
    <ul id="selected-columns" style="list-style:none;padding:0;margin:0.5rem 0;">
      {% for col in selected_columns %}
      <li data-key="{{ col.key }}" data-deps='{{ field_deps.get(col.key, [])|tojson }}' style="display:flex;align-items:center;gap:0.25rem;padding:0.3rem 0.5rem;margin-bottom:0.25rem;background:var(--pico-card-background-color);border:1px solid var(--pico-muted-border-color);border-radius:4px;cursor:grab;">
        <span style="flex:1;">{{ col.label }}</span>
        <input type="text" class="col-label" value="{{ col.label_override }}" placeholder="Custom label" style="width:8rem;padding:0.15rem 0.3rem;font-size:0.8rem;margin:0;">
        <input type="number" class="col-width" value="{{ col.width_px }}" placeholder="Width" min="50" max="800" style="width:5rem;padding:0.15rem 0.3rem;font-size:0.8rem;margin:0;">
        <button type="button" class="outline secondary move-up" style="padding:0.1rem 0.4rem;font-size:0.75rem;" title="Move up">&#9650;</button>
        <button type="button" class="outline secondary move-down" style="padding:0.1rem 0.4rem;font-size:0.75rem;" title="Move down">&#9660;</button>
        <button type="button" class="outline secondary remove-col" style="padding:0.1rem 0.4rem;font-size:0.75rem;" title="Remove">&times;</button>
      </li>
      {% endfor %}
    </ul>

    <div style="display:flex;gap:0.5rem;align-items:end;">
      <select id="add-column-select" style="flex:1;margin-bottom:0;">
        {% for col in available_columns %}
        <option value="{{ col.key }}">{{ col.label }}</option>
        {% endfor %}
        {% if not available_columns %}
        <option value="" disabled>All columns added</option>
        {% endif %}
      </select>
      <button type="button" id="add-column-btn" class="outline secondary" style="margin-bottom:0;white-space:nowrap;" {% if not available_columns %}disabled{% endif %}>+ Add</button>
    </div>
  </fieldset>

  <input type="hidden" name="columns_json" id="columns_json" value="[]">

  {# Filters #}
  <fieldset>
    <legend>Filters</legend>
    <div id="filter-rows">
      {% for f in view.filters %}
      <div class="filter-row" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:end;">
        <select class="filter-field" style="flex:1;">
          {% for fk, fdef in entity_def.fields.items() %}
          {% if fdef.filterable %}
          <option value="{{ fk }}" {% if f.field_key == fk %}selected{% endif %}>{{ fdef.label }}</option>
          {% endif %}
          {% endfor %}
        </select>
        <select class="filter-op" style="width:12rem;">
          {% for op_key, op_label in operator_labels.items() %}
          <option value="{{ op_key }}" {% if f.operator == op_key %}selected{% endif %}>{{ op_label }}</option>
          {% endfor %}
        </select>
        <input type="text" class="filter-val" value="{{ f.value or '' }}" placeholder="Value" style="flex:1;">
        <button type="button" class="outline secondary remove-filter" style="padding:0.3rem 0.5rem;">&times;</button>
      </div>
      {% endfor %}
    </div>
    <button type="button" id="add-filter" class="outline secondary" style="font-size:0.85rem;">+ Add Filter</button>
  </fieldset>

  <input type="hidden" id="filters_json" name="filters_json" value="[]">

  <button type="submit">Save View</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectedList = document.getElementById('selected-columns');
  const addSelect = document.getElementById('add-column-select');
  const addBtn = document.getElementById('add-column-btn');
  const columnsInput = document.getElementById('columns_json');
  const filterRows = document.getElementById('filter-rows');
  const filtersInput = document.getElementById('filters_json');
  const addFilterBtn = document.getElementById('add-filter');

  // Field labels for dynamic add (all non-hidden fields)
  const allFields = {
    {% for fk, fdef in entity_def.fields.items() %}
    {% if fdef.type != 'hidden' %}
    "{{ fk }}": "{{ fdef.label }}",
    {% endif %}
    {% endfor %}
  };

  // Field deps for auto-include
  const fieldDeps = {{ field_deps_json|safe }};

  // Filterable fields
  const filterableFields = [
    {% for fk, fdef in entity_def.fields.items() %}
    {% if fdef.filterable %}
    {key: "{{ fk }}", label: "{{ fdef.label }}"},
    {% endif %}
    {% endfor %}
  ];

  // Operator labels
  const opLabels = {
    {% for op_key, op_label in operator_labels.items() %}
    "{{ op_key }}": "{{ op_label }}",
    {% endfor %}
  };

  // ---- Column management ----

  function wireColumnButtons(li) {
    li.querySelector('.move-up').addEventListener('click', function() {
      const prev = li.previousElementSibling;
      if (prev) selectedList.insertBefore(li, prev);
    });
    li.querySelector('.move-down').addEventListener('click', function() {
      const next = li.nextElementSibling;
      if (next) selectedList.insertBefore(next, li);
    });
    li.querySelector('.remove-col').addEventListener('click', function() {
      const key = li.dataset.key;
      li.remove();
      // Add back to available dropdown
      const opt = document.createElement('option');
      opt.value = key;
      opt.textContent = allFields[key] || key;
      addSelect.appendChild(opt);
      addBtn.disabled = false;
    });
  }

  // Wire existing column buttons
  selectedList.querySelectorAll('li').forEach(wireColumnButtons);

  addBtn.addEventListener('click', function() {
    const key = addSelect.value;
    if (!key) return;
    const label = addSelect.options[addSelect.selectedIndex].text;

    // Create li
    const li = document.createElement('li');
    li.dataset.key = key;
    li.dataset.deps = JSON.stringify(fieldDeps[key] || []);
    li.style.cssText = 'display:flex;align-items:center;gap:0.25rem;padding:0.3rem 0.5rem;margin-bottom:0.25rem;background:var(--pico-card-background-color);border:1px solid var(--pico-muted-border-color);border-radius:4px;cursor:grab;';
    li.innerHTML = `
      <span style="flex:1;">${label}</span>
      <input type="text" class="col-label" value="" placeholder="Custom label" style="width:8rem;padding:0.15rem 0.3rem;font-size:0.8rem;margin:0;">
      <input type="number" class="col-width" value="" placeholder="Width" min="50" max="800" style="width:5rem;padding:0.15rem 0.3rem;font-size:0.8rem;margin:0;">
      <button type="button" class="outline secondary move-up" style="padding:0.1rem 0.4rem;font-size:0.75rem;" title="Move up">&#9650;</button>
      <button type="button" class="outline secondary move-down" style="padding:0.1rem 0.4rem;font-size:0.75rem;" title="Move down">&#9660;</button>
      <button type="button" class="outline secondary remove-col" style="padding:0.1rem 0.4rem;font-size:0.75rem;" title="Remove">&times;</button>
    `;
    selectedList.appendChild(li);
    wireColumnButtons(li);

    // Remove from dropdown
    addSelect.querySelector(`option[value="${key}"]`).remove();
    if (addSelect.options.length === 0) {
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.disabled = true;
      placeholder.textContent = 'All columns added';
      addSelect.appendChild(placeholder);
      addBtn.disabled = true;
    }
  });

  // ---- Filter management ----

  function addFilterRow(fieldKey, op, val) {
    const row = document.createElement('div');
    row.className = 'filter-row';
    row.style.cssText = 'display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:end;';
    row.innerHTML = `
      <select class="filter-field" style="flex:1;">
        ${filterableFields.map(f => `<option value="${f.key}" ${f.key === fieldKey ? 'selected' : ''}>${f.label}</option>`).join('')}
      </select>
      <select class="filter-op" style="width:12rem;">
        ${Object.entries(opLabels).map(([k,v]) => `<option value="${k}" ${k === op ? 'selected' : ''}>${v}</option>`).join('')}
      </select>
      <input type="text" class="filter-val" value="${val || ''}" placeholder="Value" style="flex:1;">
      <button type="button" class="outline secondary remove-filter" style="padding:0.3rem 0.5rem;">&times;</button>
    `;
    filterRows.appendChild(row);
    row.querySelector('.remove-filter').addEventListener('click', function() {
      row.remove();
    });
  }

  addFilterBtn.addEventListener('click', function() {
    addFilterRow(filterableFields.length ? filterableFields[0].key : '', 'equals', '');
  });

  // Wire up existing remove buttons
  filterRows.querySelectorAll('.remove-filter').forEach(btn => {
    btn.addEventListener('click', function() {
      btn.closest('.filter-row').remove();
    });
  });

  // ---- Form submit: serialize columns + filters ----

  document.getElementById('edit-view-form').addEventListener('submit', function() {
    // Serialize column order with label/width overrides
    const cols = [];
    selectedList.querySelectorAll('li').forEach(li => {
      const obj = {key: li.dataset.key};
      const labelInput = li.querySelector('.col-label');
      const widthInput = li.querySelector('.col-width');
      if (labelInput && labelInput.value.trim()) obj.label = labelInput.value.trim();
      if (widthInput && widthInput.value) obj.width = parseInt(widthInput.value, 10);
      cols.push(obj);
    });
    columnsInput.value = JSON.stringify(cols);

    // Serialize filters
    const rows = filterRows.querySelectorAll('.filter-row');
    const filters = [];
    rows.forEach(row => {
      const field_key = row.querySelector('.filter-field').value;
      const operator = row.querySelector('.filter-op').value;
      const value = row.querySelector('.filter-val').value;
      filters.push({field_key, operator, value: value || null});
    });
    filtersInput.value = JSON.stringify(filters);
  });
});
</script>
{% endblock %}
